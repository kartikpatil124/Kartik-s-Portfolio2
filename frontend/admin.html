<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - KK Projects</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        .admin-container {
            margin-top: 80px;
            min-height: 100vh;
            background: #f8f9fa;
        }
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .projects-list {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .logout-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        .contacts-list {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.message-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.message-card.unread {
    border-left-color: #dc3545;
    background-color: #f8f9fa;
}

.message-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.contacts-list {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.message-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.message-card.unread {
    border-left-color: #dc3545;
    background-color: #f8f9fa;
}

.message-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.badge.unread-badge {
    background-color: #dc3545;
}
    </style>
</head>
<body>
    <!-- Logout Button -->
    <button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

    <div class="admin-container">
        <div class="container">
            <h1 class="text-center mb-5 section-title">Admin Panel</h1>
            
            <!-- Add Project Form -->
            <div class="form-container">
                <h3 class="mb-4">Add New Project</h3>
                <form id="projectForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Project Title</label>
                            <input type="text" class="form-control" id="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="categories" class="form-label">Category</label>
                            <select class="form-select" id="categories" multiple required>
                                <option value="html">HTML</option>
                                <option value="css">CSS & Bootstrap</option>
                                <option value="javascript">JavaScript</option>
                                <option value="react">ReactJS</option>
                                <option value="node">Node.JS</option>
                            </select>
                            <div class="form-text">Hold Ctrl (Windows) or Cmd (Mac) to select multiple.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="imageUrl" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="imageUrl" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectLink" class="form-label">Project Link</label>
                            <input type="url" class="form-control" id="projectLink" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="githubLink" class="form-label">GitHub Link</label>
                            <input type="url" class="form-control" id="githubLink" placeholder="https://github.com/username/repo">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Project</button>
                </form>
            </div>

            <!-- Projects List -->
            <div class="projects-list">
                <h3 class="mb-4">Existing Projects</h3>
                <div id="projectsList">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Contact Messages Section -->
<!-- Contact Messages Section -->
<div class="contacts-list mt-5">
    <div class="form-container">
        <h3 class="mb-4">Contact Messages</h3>
        <div class="mb-3">
            <button class="btn btn-secondary btn-sm" onclick="loadContactMessages()">
                Refresh Messages
            </button>
        </div>
        <div id="contactsList">
            <!-- Contact messages will be loaded here -->
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------------------------------------
   FIXED API BASE
---------------------------------------------- */
const API_BASE = "https://portfolio-backend1-0061.onrender.com/api";

/* ---------------------------------------------
   LOAD PROJECTS ON PAGE LOAD
---------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
    loadAdminProjects();
    loadContactMessages();
});

/* ---------------------------------------------
   ADD PROJECT
---------------------------------------------- */
document.getElementById("projectForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const selectedCategories = Array.from(
        document.getElementById("categories").selectedOptions
    ).map(o => o.value);

    const projectData = {
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        imageUrl: document.getElementById("imageUrl").value,
        projectLink: document.getElementById("projectLink").value,
        githubLink: document.getElementById("githubLink").value || "",
        category: selectedCategories
    };

    try {
        const response = await fetch(`${API_BASE}/projects`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(projectData)
        });

        const result = await response.json();

        if (result.success) {
            alert("Project added successfully!");
            this.reset();
            loadAdminProjects();
        } else {
            alert("Error adding project");
        }
    } catch (err) {
        console.error(err);
        alert("Server error while adding project.");
    }
});

/* ---------------------------------------------
   LOAD PROJECTS
---------------------------------------------- */
async function loadAdminProjects() {
    try {
        const response = await fetch(`${API_BASE}/projects`);
        const projects = await response.json();

        const container = document.getElementById("projectsList");

        if (!projects.length) {
            container.innerHTML = `<p class="text-muted">No projects added yet.</p>`;
            return;
        }

        container.innerHTML = projects
            .map(project => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title">${project.title}</h5>
                                <p class="card-text">${project.description}</p>
                                <div class="d-flex flex-wrap gap-1">
                                    ${renderCategoryBadges(project.category)}
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-danger btn-sm" onclick="deleteProject('${project._id}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `)
            .join("");
    } catch (err) {
        console.error("Error loading projects:", err);
    }
}

/* ---------------------------------------------
   DELETE PROJECT
---------------------------------------------- */
async function deleteProject(id) {
    if (!confirm("Are you sure you want to delete this project?")) return;

    try {
        const response = await fetch(`${API_BASE}/projects/${id}`, {
            method: "DELETE"
        });

        const result = await response.json();

        if (result.success) {
            alert("Project deleted successfully!");
            loadAdminProjects();
        } else {
            alert("Error deleting project.");
        }
    } catch (err) {
        console.error(err);
        alert("Server error while deleting.");
    }
}

/* ---------------------------------------------
   CATEGORY BADGES
---------------------------------------------- */
function renderCategoryBadges(category) {
    const items = Array.isArray(category) ? category : [category];

    const nameMap = {
        html: "HTML",
        css: "CSS & Bootstrap",
        javascript: "JavaScript",
        react: "ReactJS",
        node: "Node.js"
    };

    return items
        .map(c => `<span class="badge bg-primary">${nameMap[c] || c}</span>`)
        .join("");
}

/* ---------------------------------------------
   LOGOUT
---------------------------------------------- */
function logout() {
    window.location.href = "index.html";
}

/* ---------------------------------------------
   CONTACT MESSAGES (READ + DELETE)
---------------------------------------------- */
async function loadContactMessages() {
    try {
        const response = await fetch(`${API_BASE}/contacts`);
        const messages = await response.json();

        const list = document.getElementById("contactsList");

        if (!messages.length) {
            list.innerHTML = `<p class="text-muted">No messages yet.</p>`;
            return;
        }

        list.innerHTML = messages
            .map(msg => `
                <div class="card mb-3 message-card ${msg.read ? "" : "unread"}" id="msg-${msg._id}">
                    <div class="card-body">
                        <h5>${msg.subject}</h5>
                        <h6 class="text-muted">From: ${msg.name} (${msg.email})</h6>
                        <p>${msg.message}</p>
                        <small class="text-muted">${new Date(msg.createdAt).toLocaleString()}</small>
                        <div class="mt-2">
                            ${
                                msg.read
                                    ? `<span class="badge bg-success">Read</span>`
                                    : `<button class="btn btn-success btn-sm" onclick="markAsRead('${msg._id}')">Mark Read</button>`
                            }
                            <button class="btn btn-danger btn-sm ms-2" onclick="deleteContact('${msg._id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `)
            .join("");
    } catch (err) {
        console.error("Error loading contact messages:", err);
    }
}

async function markAsRead(id) {
    try {
        await fetch(`${API_BASE}/contacts/${id}/read`, { method: "PUT" });

        document.getElementById(`msg-${id}`).classList.remove("unread");
        loadContactMessages();
    } catch (err) {
        console.error(err);
    }
}

async function deleteContact(id) {
    if (!confirm("Delete this message?")) return;

    try {
        await fetch(`${API_BASE}/contacts/${id}`, { method: "DELETE" });
        document.getElementById(`msg-${id}`).remove();
    } catch (err) {
        console.error(err);
    }
}
</script>

</body>
</html>
