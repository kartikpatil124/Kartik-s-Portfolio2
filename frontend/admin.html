<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - KK Projects</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">

<style>
    .admin-container {
        margin-top: 80px;
        min-height: 100vh;
        background: #f8f9fa;
    }
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .projects-list, .contacts-list {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-top: 2rem;
    }
    .logout-btn {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
    }
    .message-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    .message-card.unread {
        border-left-color: #dc3545;
        background-color: #f8f9fa;
    }
    .message-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* ============= NEW STYLES FOR IMAGE UPLOAD BOX ============= */
    .upload-box {
        width: 100%;
        height: 130px;
        border: 2px dashed #aaa;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #666;
        cursor: pointer;
        transition: 0.3s;
        text-align: center;
        padding: 10px;
        font-size: 0.9rem;
        background-color: #fdfdfd;
        margin-top: 8px;
    }
    .upload-box:hover {
        background: #f2f2f2;
    }
    .upload-box.dragover {
        background: #e3ffe3;
        border-color: #22aa22;
        color: #22aa22;
    }
    #previewImage {
        width: 100%;
        margin-top: 10px;
        border-radius: 10px;
        object-fit: cover;
        max-height: 220px;
    }
</style>
</head>

<body>
<button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

<div class="admin-container">
    <div class="container">
        <h1 class="text-center mb-5 section-title">Admin Panel</h1>

        <!-- Add Project Form -->
        <div class="form-container">
            <h3 class="mb-4">Add New Project</h3>

            <form id="projectForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Title</label>
                        <input type="text" id="title" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="categories" multiple required>
                            <option value="html">HTML</option>
                            <option value="css">CSS & Bootstrap</option>
                            <option value="javascript">JavaScript</option>
                            <option value="react">ReactJS</option>
                            <option value="node">Node.JS</option>
                        </select>
                        <small>Hold Ctrl / Cmd to select multiple</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="description" rows="3" class="form-control" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Image URL</label>
                        <!-- OLD INPUT (UNCHANGED) -->
                        <input type="url" id="imageUrl" class="form-control" required>

                        <!-- ========== NEW UPLOAD OPTIONS (ADDED) ========== -->
                        <div class="upload-box" id="uploadBox">
                            <div>
                                <strong>Drag & Drop an image here</strong><br>
                                or <u>click to select from your device</u><br>
                                <small>(Uploads to Cloudinary & fills Image URL automatically)</small>
                            </div>
                            <input type="file" id="imageFile" accept="image/*" hidden>
                        </div>
                        <img id="previewImage" style="display:none;" alt="Image Preview">
                        <!-- ========== END NEW UPLOAD UI ========== -->
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Link</label>
                        <input type="url" id="projectLink" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">GitHub Link</label>
                        <input type="url" id="githubLink" class="form-control">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Add Project</button>
            </form>
        </div>

        <!-- Existing Projects -->
        <div class="projects-list">
            <h3 class="mb-4">Existing Projects</h3>
            <div id="projectsList"></div>
        </div>

        <!-- Contact Messages -->
        <div class="contacts-list mt-5">
            <h3 class="mb-3">Contact Messages</h3>
            <button class="btn btn-secondary btn-sm mb-3" onclick="loadContactMessages()">Refresh</button>
            <div id="contactsList"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========================
// API BASE URL
// ========================
const API_BASE = "https://portfolio-backend1-0061.onrender.com/api";

// ========================
// INITIAL LOAD
// ========================
document.addEventListener("DOMContentLoaded", () => {
    loadAdminProjects();
    loadContactMessages();
});

// ========================
// ADD PROJECT
// ========================
document.getElementById("projectForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const selectedCategories = Array.from(
        document.getElementById("categories").selectedOptions
    ).map(o => o.value);

    const newProject = {
        title: title.value,
        description: description.value,
        imageUrl: imageUrl.value,          // uses URL or uploaded image URL
        projectLink: projectLink.value,
        githubLink: githubLink.value || "",
        category: selectedCategories,
    };

    try {
        const response = await fetch(`${API_BASE}/projects`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newProject),
        });

        const result = await response.json();

        if (result._id) {
            alert("Project added successfully!");
            this.reset();
            // Reset preview too
            const previewImage = document.getElementById("previewImage");
            previewImage.style.display = "none";
            previewImage.src = "";
            loadAdminProjects();
        } else {
            alert("Error adding project.");
        }
    } catch (err) {
        console.error(err);
        alert("Server error.");
    }
});

// ========================
// LOAD PROJECTS
// ========================
async function loadAdminProjects() {
    try {
        const response = await fetch(`${API_BASE}/projects`);
        const projects = await response.json();
        const list = document.getElementById("projectsList");

        if (!projects.length) {
            list.innerHTML = `<p class="text-muted">No projects added.</p>`;
            return;
        }

        list.innerHTML = projects
            .map(
                (p) => `
            <div class="card mb-3">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <h5>${p.title}</h5>
                        <p>${p.description}</p>
                        <div>${renderCategoryBadges(p.category)}</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteProject('${p._id}')">Delete</button>
                </div>
            </div>
        `
            )
            .join("");
    } catch (err) {
        console.error("Error fetching projects:", err);
    }
}

// ========================
// DELETE PROJECT
// ========================
async function deleteProject(id) {
    if (!confirm("Delete this project?")) return;

    try {
        const response = await fetch(`${API_BASE}/projects/${id}`, {
            method: "DELETE",
        });

        const result = await response.json();

        if (result.success) {
            alert("Project deleted!");
            loadAdminProjects();
        } else {
            alert("Delete failed.");
        }
    } catch (err) {
        console.error(err);
        alert("Server error.");
    }
}

// ========================
// CATEGORY BADGES
// ========================
function renderCategoryBadges(category) {
    const cats = Array.isArray(category) ? category : [category];
    const names = {
        html: "HTML",
        css: "CSS & Bootstrap",
        javascript: "JavaScript",
        react: "ReactJS",
        node: "Node.JS",
    };

    return cats.map((c) => `<span class="badge bg-primary me-1">${names[c] || c}</span>`).join("");
}

// ========================
// CONTACT MESSAGES
// ========================
async function loadContactMessages() {
    try {
        const res = await fetch(`${API_BASE}/contacts`);
        const messages = await res.json();
        const container = document.getElementById("contactsList");

        if (!messages.length) {
            container.innerHTML = `<p class="text-muted">No messages yet.</p>`;
            return;
        }

        container.innerHTML = messages
            .map(
                (m) => `
            <div class="card mb-3 message-card ${m.read ? "" : "unread"}" id="msg-${m._id}">
                <div class="card-body">
                    <h5>${m.name} (${m.email})</h5>
                    <p>${m.message}</p>
                    <small class="text-muted">${new Date(m.createdAt).toLocaleString()}</small>

                    <div class="mt-2">
                        ${
                            m.read
                                ? `<span class="badge bg-success">Read</span>`
                                : `<button class="btn btn-success btn-sm" onclick="markAsRead('${m._id}')">Mark Read</button>`
                        }
                        <button class="btn btn-danger btn-sm ms-2" onclick="deleteContact('${m._id}')">Delete</button>
                    </div>
                </div>
            </div>
        `
            )
            .join("");
    } catch (err) {
        console.error("Error loading messages:", err);
    }
}

async function markAsRead(id) {
    await fetch(`${API_BASE}/contacts/${id}/read`, { method: "PUT" });
    loadContactMessages();
}

async function deleteContact(id) {
    if (!confirm("Delete this message?")) return;
    await fetch(`${API_BASE}/contacts/${id}`, { method: "DELETE" });
    const el = document.getElementById(`msg-${id}`);
    if (el) el.remove();
}

// ========================
// LOGOUT
// ========================
function logout() {
    window.location.href = "index.html";
}

// =====================================================
// NEW: CLOUDINARY IMAGE UPLOAD (FILE + DRAG & DROP)
// =====================================================

// ✏️ REPLACE THESE WITH YOUR REAL CLOUDINARY VALUES
const CLOUD_NAME = "YOUR_CLOUD_NAME";
const UPLOAD_PRESET = "YOUR_UPLOAD_PRESET";

const uploadBox = document.getElementById("uploadBox");
const imageFileInput = document.getElementById("imageFile");
const previewImage = document.getElementById("previewImage");
const imageUrlInput = document.getElementById("imageUrl");

// Click → open file picker
uploadBox.addEventListener("click", () => {
    imageFileInput.click();
});

// When file chosen
imageFileInput.addEventListener("change", () => {
    const file = imageFileInput.files[0];
    if (file) {
        uploadImageToCloudinary(file);
    }
});

// Drag over
uploadBox.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadBox.classList.add("dragover");
});

// Drag leave
uploadBox.addEventListener("dragleave", () => {
    uploadBox.classList.remove("dragover");
});

// Drop file
uploadBox.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadBox.classList.remove("dragover");
    const file = e.dataTransfer.files[0];
    if (file) {
        uploadImageToCloudinary(file);
    }
});

async function uploadImageToCloudinary(file) {
    try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: formData,
        });

        const data = await res.json();
        console.log("Cloudinary response:", data);

        if (data.secure_url) {
            // Show preview
            previewImage.src = data.secure_url;
            previewImage.style.display = "block";

            // Fill into existing Image URL input
            imageUrlInput.value = data.secure_url;
        } else {
            alert("Image upload failed. Check Cloudinary config.");
        }
    } catch (err) {
        console.error("Cloudinary upload error:", err);
        alert("Error uploading image.");
    }
}
</script>

</body>
</html>
