<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - KK Projects</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">

<style>
    .admin-container {
        margin-top: 80px;
        min-height: 100vh;
        background: #f8f9fa;
    }
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .projects-list, .contacts-list {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-top: 2rem;
    }
    .logout-btn {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
    }
    .message-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    .message-card.unread {
        border-left-color: #dc3545;
        background-color: #f8f9fa;
    }
    .message-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
</head>

<body>
<button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

<div class="admin-container">
    <div class="container">
        <h1 class="text-center mb-5 section-title">Admin Panel</h1>

        <!-- Add Project Form -->
        <div class="form-container">
            <h3 class="mb-4">Add New Project</h3>

            <form id="projectForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Title</label>
                        <input type="text" id="title" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="categories" multiple required>
                            <option value="html">HTML</option>
                            <option value="css">CSS & Bootstrap</option>
                            <option value="javascript">JavaScript</option>
                            <option value="react">ReactJS</option>
                            <option value="node">Node.JS</option>
                        </select>
                        <small>Hold Ctrl / Cmd to select multiple</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="description" rows="3" class="form-control" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="url" id="imageUrl" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Link</label>
                        <input type="url" id="projectLink" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">GitHub Link</label>
                        <input type="url" id="githubLink" class="form-control">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Add Project</button>
            </form>
        </div>

        <!-- Existing Projects -->
        <div class="projects-list">
            <h3 class="mb-4">Existing Projects</h3>
            <div id="projectsList"></div>
        </div>

        <!-- Contact Messages -->
        <div class="contacts-list mt-5">
            <h3 class="mb-3">Contact Messages</h3>
            <button class="btn btn-secondary btn-sm mb-3" onclick="loadContactMessages()">Refresh</button>
            <div id="contactsList"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========================
// API BASE URL
// ========================
const API_BASE = "https://portfolio-backend1-0061.onrender.com/api";

// ========================
// INITIAL LOAD
// ========================
document.addEventListener("DOMContentLoaded", () => {
    loadAdminProjects();
    loadContactMessages();
});

// ========================
// ADD PROJECT
// ========================
document.getElementById("projectForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const selectedCategories = Array.from(
        document.getElementById("categories").selectedOptions
    ).map(o => o.value);

    const newProject = {
        title: title.value,
        description: description.value,
        imageUrl: imageUrl.value,
        projectLink: projectLink.value,
        githubLink: githubLink.value || "",
        category: selectedCategories,
    };

    try {
        const response = await fetch(`${API_BASE}/projects`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newProject),
        });

        const result = await response.json();

        if (result._id) {
            alert("Project added successfully!");
            this.reset();
            loadAdminProjects();
        } else {
            alert("Error adding project.");
        }
    } catch (err) {
        console.error(err);
        alert("Server error.");
    }
});

// ========================
// LOAD PROJECTS
// ========================
async function loadAdminProjects() {
    try {
        const response = await fetch(`${API_BASE}/projects`);
        const projects = await response.json();
        const list = document.getElementById("projectsList");

        if (!projects.length) {
            list.innerHTML = `<p class="text-muted">No projects added.</p>`;
            return;
        }

        list.innerHTML = projects
            .map(
                (p) => `
            <div class="card mb-3">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <h5>${p.title}</h5>
                        <p>${p.description}</p>
                        <div>${renderCategoryBadges(p.category)}</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteProject('${p._id}')">Delete</button>
                </div>
            </div>
        `
            )
            .join("");
    } catch (err) {
        console.error("Error fetching projects:", err);
    }
}

// ========================
// DELETE PROJECT
// ========================
async function deleteProject(id) {
    if (!confirm("Delete this project?")) return;

    try {
        const response = await fetch(`${API_BASE}/projects/${id}`, {
            method: "DELETE",
        });

        const result = await response.json();

        if (result.success) {
            alert("Project deleted!");
            loadAdminProjects();
        } else {
            alert("Delete failed.");
        }
    } catch (err) {
        console.error(err);
        alert("Server error.");
    }
}

// ========================
// CATEGORY BADGES
// ========================
function renderCategoryBadges(category) {
    const cats = Array.isArray(category) ? category : [category];
    const names = {
        html: "HTML",
        css: "CSS & Bootstrap",
        javascript: "JavaScript",
        react: "ReactJS",
        node: "Node.JS",
    };

    return cats.map((c) => `<span class="badge bg-primary me-1">${names[c] || c}</span>`).join("");
}

// ========================
// CONTACT MESSAGES
// ========================
async function loadContactMessages() {
    try {
        const res = await fetch(`${API_BASE}/contacts`);
        const messages = await res.json();
        const container = document.getElementById("contactsList");

        if (!messages.length) {
            container.innerHTML = `<p class="text-muted">No messages yet.</p>`;
            return;
        }

        container.innerHTML = messages
            .map(
                (m) => `
            <div class="card mb-3 message-card ${m.read ? "" : "unread"}" id="msg-${m._id}">
                <div class="card-body">
                    <h5>${m.name} (${m.email})</h5>
                    <p>${m.message}</p>
                    <small class="text-muted">${new Date(m.createdAt).toLocaleString()}</small>

                    <div class="mt-2">
                        ${
                            m.read
                                ? `<span class="badge bg-success">Read</span>`
                                : `<button class="btn btn-success btn-sm" onclick="markAsRead('${m._id}')">Mark Read</button>`
                        }
                        <button class="btn btn-danger btn-sm ms-2" onclick="deleteContact('${m._id}')">Delete</button>
                    </div>
                </div>
            </div>
        `
            )
            .join("");
    } catch (err) {
        console.error("Error loading messages:", err);
    }
}

async function markAsRead(id) {
    await fetch(`${API_BASE}/contacts/${id}/read`, { method: "PUT" });
    loadContactMessages();
}

async function deleteContact(id) {
    if (!confirm("Delete this message?")) return;
    await fetch(`${API_BASE}/contacts/${id}`, { method: "DELETE" });
    document.getElementById(`msg-${id}`).remove();
}

// ========================
// LOGOUT
// ========================
function logout() {
    window.location.href = "index.html";
}
</script>

</body>
</html>
