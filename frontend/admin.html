<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - KK Projects</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        .admin-container {
            margin-top: 80px;
            min-height: 100vh;
            background: #f8f9fa;
        }
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .projects-list {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .logout-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        .contacts-list {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.message-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.message-card.unread {
    border-left-color: #dc3545;
    background-color: #f8f9fa;
}

.message-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.contacts-list {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.message-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.message-card.unread {
    border-left-color: #dc3545;
    background-color: #f8f9fa;
}

.message-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.badge.unread-badge {
    background-color: #dc3545;
}
    </style>
</head>
<body>
    <!-- Logout Button -->
    <button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>

    <div class="admin-container">
        <div class="container">
            <h1 class="text-center mb-5 section-title">Admin Panel</h1>
            
            <!-- Add Project Form -->
            <div class="form-container">
                <h3 class="mb-4">Add New Project</h3>
                <form id="projectForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Project Title</label>
                            <input type="text" class="form-control" id="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="categories" class="form-label">Category</label>
                            <select class="form-select" id="categories" multiple required>
                                <option value="html">HTML</option>
                                <option value="css">CSS & Bootstrap</option>
                                <option value="javascript">JavaScript</option>
                                <option value="react">ReactJS</option>
                                <option value="node">Node.JS</option>
                            </select>
                            <div class="form-text">Hold Ctrl (Windows) or Cmd (Mac) to select multiple.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="imageUrl" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="imageUrl" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectLink" class="form-label">Project Link</label>
                            <input type="url" class="form-control" id="projectLink" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="githubLink" class="form-label">GitHub Link</label>
                            <input type="url" class="form-control" id="githubLink" placeholder="https://github.com/username/repo">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Project</button>
                </form>
            </div>

            <!-- Projects List -->
            <div class="projects-list">
                <h3 class="mb-4">Existing Projects</h3>
                <div id="projectsList">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Contact Messages Section -->
<!-- Contact Messages Section -->
<div class="contacts-list mt-5">
    <div class="form-container">
        <h3 class="mb-4">Contact Messages</h3>
        <div class="mb-3">
            <button class="btn btn-secondary btn-sm" onclick="loadContactMessages()">
                Refresh Messages
            </button>
        </div>
        <div id="contactsList">
            <!-- Contact messages will be loaded here -->
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://portfolio-backend1-0061.onrender.com/api/projects';

        // Load existing projects
        document.addEventListener('DOMContentLoaded', loadAdminProjects);

        // Handle project form submission
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedCategories = Array.from(document.getElementById('categories').selectedOptions).map(o => o.value);

            const projectData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                imageUrl: document.getElementById('imageUrl').value,
                projectLink: document.getElementById('projectLink').value,
                githubLink: document.getElementById('githubLink')?.value || '',
                category: selectedCategories
            };

            try {
                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Project added successfully!');
                    this.reset();
                    loadAdminProjects();
                } else {
                    alert('Error adding project');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding project');
            }
        });

        // Load projects for admin
        async function loadAdminProjects() {
            try {
                const response = await fetch(`${API_BASE}/projects`);
                const projects = await response.json();
                
                const projectsList = document.getElementById('projectsList');
                
                if (projects.length === 0) {
                    projectsList.innerHTML = '<p class="text-muted">No projects added yet.</p>';
                    return;
                }

                projectsList.innerHTML = projects.map(project => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="card-title">${project.title}</h5>
                                    <p class="card-text">${project.description}</p>
                                    <!-- render badges for one or many categories -->
                                    <div class="d-flex flex-wrap gap-1">
                                        ${renderCategoryBadges(project.category)}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Delete project
        async function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Project deleted successfully!');
                        loadAdminProjects();
                    } else {
                        alert('Error deleting project');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting project');
                }
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = "index.html";
            }
        }

        function renderCategoryBadges(category) {
            const cats = Array.isArray(category) ? category : (category ? [category] : []);
            return cats
                .map(c => `<span class="badge bg-primary">${getCategoryDisplayNameAdmin(c)}</span>`)
                .join('');
        }

        function getCategoryDisplayNameAdmin(category) {
            const map = {
                'html': 'HTML',
                'css': 'CSS & Bootstrap',
                'javascript': 'JavaScript',
                'react': 'ReactJS',
                'node': 'Node.JS'
            };
            return map[category] || category || '';
        }


        // In the project form submission handler, update this part:
const projectData = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    imageUrl: document.getElementById('imageUrl').value,
    projectLink: document.getElementById('projectLink').value,
    githubLink: document.getElementById('githubLink').value || '', // Ensure empty string if not provided
    category: selectedCategories
};

// Load contact messages
async function loadContactMessages() {
    try {
        const response = await fetch(`${API_BASE}/contacts`);
        const contacts = await response.json();
        
        const contactsList = document.getElementById('contactsList');
        
        if (contacts.length === 0) {
            contactsList.innerHTML = '<p class="text-muted">No contact messages yet.</p>';
            return;
        }

        // Sort by date (newest first)
        contacts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        contactsList.innerHTML = contacts.map(contact => `
            <div class="card mb-3 message-card ${contact.read ? '' : 'unread'}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title">${contact.subject}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                From: ${contact.name} (${contact.email})
                            </h6>
                            <p class="card-text">${contact.message}</p>
                            <small class="text-muted">
                                Received: ${new Date(contact.createdAt).toLocaleString()}
                            </small>
                        </div>
                        <div class="btn-group ms-3">
                            ${!contact.read ? 
                                `<button class="btn btn-success btn-sm" onclick="markAsRead('${contact.id}')">Mark Read</button>` : 
                                `<span class="badge bg-success">Read</span>`
                            }
                            <button class="btn btn-danger btn-sm ms-2" onclick="deleteContact('${contact.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading contacts:', error);
    }
}

// Mark message as read
async function markAsRead(contactId) {
    try {
        const response = await fetch(`${API_BASE}/contacts/${contactId}/read`, {
            method: 'PUT'
        });

        const result = await response.json();

        if (result.success) {
            loadContactMessages();
        } else {
            alert('Error marking message as read');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error marking message as read');
    }
}

// Delete contact message
async function deleteContact(contactId) {
    if (confirm('Are you sure you want to delete this message?')) {
        try {
            const response = await fetch(`${API_BASE}/contacts/${contactId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                loadContactMessages();
            } else {
                alert('Error deleting message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting message');
        }
    }
}

// Update the DOMContentLoaded event to also load contact messages
document.addEventListener('DOMContentLoaded', function() {
    loadAdminProjects();
    loadContactMessages();
});

// Load contact messages
async function loadContactMessages() {
    try {
        console.log('Loading contact messages...');
        const response = await fetch(`${API_BASE}/contacts`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contacts = await response.json();
        console.log('Loaded contacts:', contacts);
        
        const contactsList = document.getElementById('contactsList');
        
        if (contacts.length === 0) {
            contactsList.innerHTML = '<p class="text-muted">No contact messages yet.</p>';
            return;
        }

        // Sort by date (newest first)
        contacts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        contactsList.innerHTML = contacts.map(contact => `
            <div class="card mb-3 message-card ${contact.read ? '' : 'unread'}" id="contact-${contact.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${contact.subject}</h5>
                                <div>
                                    ${!contact.read ? '<span class="badge unread-badge">New</span>' : ''}
                                    <small class="text-muted ms-2">
                                        ${new Date(contact.createdAt).toLocaleString()}
                                    </small>
                                </div>
                            </div>
                            <h6 class="card-subtitle mb-2 text-muted">
                                From: <strong>${contact.name}</strong> (${contact.email})
                            </h6>
                            <p class="card-text mt-3">${contact.message}</p>
                        </div>
                        <div class="btn-group ms-3 flex-shrink-0">
                            ${!contact.read ? 
                                `<button class="btn btn-success btn-sm" onclick="markAsRead('${contact.id}')">Mark Read</button>` : 
                                `<span class="badge bg-success">Read</span>`
                            }
                            <button class="btn btn-danger btn-sm ms-2" onclick="deleteContact('${contact.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contactsList').innerHTML = 
            '<div class="alert alert-danger">Error loading contact messages: ' + error.message + '</div>';
    }
}

// Mark message as read
async function markAsRead(contactId) {
    try {
        const response = await fetch(`${API_BASE}/contacts/${contactId}/read`, {
            method: 'PUT'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            // Update the UI without reloading
            const contactElement = document.getElementById(`contact-${contactId}`);
            if (contactElement) {
                contactElement.classList.remove('unread');
                contactElement.querySelector('.btn-group').innerHTML = `
                    <span class="badge bg-success">Read</span>
                    <button class="btn btn-danger btn-sm ms-2" onclick="deleteContact('${contactId}')">Delete</button>
                `;
                contactElement.querySelector('.unread-badge')?.remove();
            }
        } else {
            alert('Error marking message as read');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error marking message as read: ' + error.message);
    }
}

// Delete contact message
async function deleteContact(contactId) {
    if (confirm('Are you sure you want to delete this message?')) {
        try {
            const response = await fetch(`${API_BASE}/contacts/${contactId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                // Remove from UI
                document.getElementById(`contact-${contactId}`)?.remove();
                
                // If no messages left, show message
                const contactsList = document.getElementById('contactsList');
                if (contactsList.children.length === 0) {
                    contactsList.innerHTML = '<p class="text-muted">No contact messages yet.</p>';
                }
            } else {
                alert('Error deleting message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting message: ' + error.message);
        }
    }
}
    </script>
</body>
</html>
